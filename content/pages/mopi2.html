<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf8">
	<TITLE>MoPi-2</TITLE>
<meta name="author" content="Lubo Bontchev" />
<meta name="category" content="News" />
<meta name="slug" content="mopi2" />
<meta name="summary" content="MoPi 2" />
<meta name="tags" content="pi,raspberrypi,raspi,mopi" />
<meta name="date" content="2018-07-16 08:58" />
	<META NAME="GENERATOR" CONTENT="OpenOffice 4.1.5  (Win32)">
	<META NAME="AUTHOR" CONTENT="Lubo Bonchev">
	<META NAME="CREATED" CONTENT="20180629;17592382">
	<META NAME="CHANGEDBY" CONTENT="Lubo Bonchev">
	<META NAME="CHANGED" CONTENT="20180705;14222490">
	<META NAME="CLASSIFICATION" CONTENT="MoPi-2 User Guide">
	<STYLE TYPE="text/css">
	<!--
		@page { margin: 2cm }
		P { margin-bottom: 0.3cm; direction: ltr; color: #000000; line-height: 120%; text-align: left; widows: 2; orphans: 2 }
		P.western { font-family: "Arial", sans-serif; font-size: 12pt; so-language: en-US }
		P.cjk { font-family: "Times New Roman", serif; font-size: 11pt }
		P.ctl { font-family: "Arial", sans-serif; font-size: 11pt; so-language: ar-SA }
		H1 { margin-top: 0.4cm; margin-bottom: 0.3cm; border: none; padding: 0cm; direction: ltr; color: #000000; line-height: 100%; text-align: left; widows: 2; orphans: 2 }
		H1.western { font-family: "Arial", sans-serif; font-size: 16pt; so-language: en-US }
		H1.cjk { font-family: "Times New Roman", serif; font-size: 16pt }
		H1.ctl { font-family: "Arial", sans-serif; font-size: 16pt; so-language: ar-SA }
		H2 { margin-top: 0.4cm; margin-bottom: 0.3cm; direction: ltr; color: #000000; line-height: 100%; text-align: left; widows: 2; orphans: 2 }
		H2.western { font-family: "Arial", sans-serif; font-size: 14pt; so-language: en-US; font-style: italic }
		H2.cjk { font-family: "Times New Roman", serif; font-size: 14pt }
		H2.ctl { font-family: "Arial", sans-serif; font-size: 14pt; so-language: ar-SA; font-style: italic }
		H3 { margin-top: 0.2cm; margin-bottom: 0.3cm; direction: ltr; color: #000000; line-height: 100%; text-align: left; widows: 2; orphans: 2 }
		H3.western { font-family: "Arial", sans-serif; font-size: 12pt; so-language: en-US; font-style: normal }
		H3.cjk { font-family: "Times New Roman", serif; font-size: 12pt; font-style: italic }
		H3.ctl { font-family: "Arial", sans-serif; font-size: 13pt; so-language: ar-SA }
		TD P { margin-bottom: 0cm; direction: ltr; color: #000000; line-height: 100%; text-align: left; widows: 2; orphans: 2; page-break-before: auto }
		TD P.western { font-family: "Arial", sans-serif; font-size: 12pt; so-language: en-US }
		TD P.cjk { font-family: "Times New Roman", serif; font-size: 11pt }
		TD P.ctl { font-family: "Arial", sans-serif; font-size: 12pt; so-language: ar-SA }
		A:link { so-language: zxx }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" TEXT="#000000" DIR="LTR">
<P CLASS="western">MoPi-2: Hot-Swap Mobile Power for the Pi Family
Boards</P>
<P CLASS="western" STYLE="line-height: 130%"><FONT SIZE=4>MoPi-2 is
<B>mobile, hot-swap and 24/7 power</B> for the <B>Raspberry Pi 2</B>
and <B>Raspberry Pi 3</B>, including the latest <B>Raspberry Pi 3 B+</B>.
The product is made in the EU. </FONT>
</P>
<P CLASS="western" STYLE="line-height: 130%"><FONT SIZE=4>You can <FONT COLOR="#ff3333"><I><B>buy
MoPi-2</B></I></FONT> from one of our <A HREF="BuyMoPi-2.html"><B>distributors</B></A>.
</FONT>
</P>
<P CLASS="western" STYLE="line-height: 130%"><FONT SIZE=4>If you have
<FONT COLOR="#ff3333"><I><B>questions</B></I></FONT> or like to <FONT COLOR="#ff3333"><I><B>rise
an issue</B></I></FONT>, please <A HREF="mailto:office@selcomltd.com"><B>E-mail
us</B></A>. </FONT>
</P>
<DIV ID="Съдържание1" DIR="LTR">
	<DIV ID="Съдържание1_Head" DIR="LTR">
		<P STYLE="margin-top: 0.42cm; margin-bottom: 0.21cm; page-break-after: avoid">
		<FONT FACE="Arial Black, sans-serif"><FONT SIZE=4 STYLE="font-size: 16pt"><B>Contents</B></FONT></FONT></P>
	</DIV>
	<P><A HREF="#__RefHeading__5506_902516158">1.Pi To Go !</A></P>
	<P><A HREF="#__RefHeading__5508_902516158">2.User Guide </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5510_902516158">2.1.Warnings!!!
	</A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__1997_1477197617">2.2.Delivery
	Kit </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__2189_1069455434">2.3.MoPi-2
	LEDs and Connectors</A></P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5512_902516158">2.4.Installation
	and Use </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5514_902516158">2.4.1.Quick
	Start </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5516_902516158">2.4.2.Installing
	the Software </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5518_902516158">2.4.3.Connecting
	the Power and the Charger</A></P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__2003_1069455434">2.4.4.Connecting
	to the Raspberry Pi  </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5520_902516158">2.4.5.Turn
	On, Turn Off </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__2007_1692238003">2.4.6.Connecting
	External Power Switch and/or Relay (Optional) </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5522_902516158">2.5.Choosing
	and Configuring Batteries (Etc.)</A></P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5524_902516158">2.5.1.Choosing
	Default Supply Profile </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5526_902516158">2.5.2.Using
	the Configuration Tool on the Pi </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5528_902516158">2.5.3.Command
	Line, Python API and Daemon Config Hacking </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5530_902516158">2.5.4.Minimum
	Number of Cells</A></P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5532_902516158">2.6.Troubleshooting
	and FAQ </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5534_902516158">2.6.1.Wh...?
	</A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5536_902516158">2.6.2.Pi
	Models: 2, 3, 3 B+ </A>
	</P>
	<P><A HREF="#__RefHeading__5538_902516158">3.The MoPi-2 Hardware </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5540_902516158">3.1.Powering
	the Pi </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5542_902516158">3.2.Load
	Signal </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5544_902516158">3.3.Charger
	Gate </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5546_902516158">3.4.Microcontroller
	</A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5548_902516158">3.5.MoPi-2
	Modes </A>
	</P>
	<P><A HREF="#__RefHeading__5550_902516158">4.The MoPi-2 Software
	Suite </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5552_902516158">4.1.simbamond,
	the simbamon daemon </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5554_902516158">4.2.The
	Python API </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5556_902516158">4.3.MoPi-2
	from the Command Line </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5558_902516158">4.4.Configuring
	Your Power Supplies </A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5560_902516158">4.5.Monitoring
	</A>
	</P>
	<P STYLE="margin-left: 0.5cm"><A HREF="#__RefHeading__5562_902516158">4.6.simbamon:
	a simple battery monitor </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5564_902516158">4.6.1.Design
	Notes </A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5566_902516158">4.6.2.Implementation
	</A>
	</P>
	<P STYLE="margin-left: 1cm"><A HREF="#__RefHeading__5568_902516158">4.6.3.Installig
	Simbamon </A>
	</P>
</DIV>
<H1 CLASS="western"><A NAME="__RefHeading__5506_902516158"></A>1.Pi
To Go !</H1>
<P CLASS="western">MoPi-2 is mobile and 24/7 power for the Pi 2 and
Pi 3 boards. On your bike, up a tree, or for your home server: we've
got you covered. MoPi-2 is successor of the well-known MoPi. 
</P>
<P CLASS="western"><IMG SRC="images/logo-heli-1.png" NAME="графики1" ALIGN=LEFT VSPACE=8 WIDTH=213 HEIGHT=160 BORDER=0><BR CLEAR=LEFT>MoPi-2
features: 
</P>
<UL>
	<LI><P CLASS="western">Two power inputs via standard screw terminals
	&mdash; for standard batteries, car power sockets, old laptop,
	supplies, solar panels, wall adapters and more 
	</P>
	<LI><P CLASS="western">Hot-swap power replacement without stopping
	work 
	</P>
	<LI><P CLASS="western">Shutdown the Pi cleanly when batteries
	discharge 
	</P>
	<LI><P CLASS="western">Right-angled power switch accessible even
	another PCB is stacked on top 
	</P>
	<LI><P CLASS="western">Usable as a UPS (uninterruptible power
	supply) by attaching both batteries and mains 
	</P>
	<LI><P CLASS="western"><SPAN LANG="en-US">Wide input voltage range:
	6.5V to 24V </SPAN><A HREF="#Footnote1"><SUP><SPAN LANG="en-US">1</SPAN></SUP></A><SPAN LANG="en-US">
	</SPAN>
	</P>
	<LI><P CLASS="western">Ability to deliver up to 2.5A @ +5V to the Pi
	and attached additional PCBs or devices 
	</P>
	<LI><P CLASS="western">Low power consumption: 15mA when is working,
	0.5mA when is sleeping and only 15 &micro;A when is off ! (more than
	10 times less than the average battery self discharge rate) 
	</P>
	<LI><P CLASS="western">Auto-off when input voltage reaches 6.0V,
	protecting the batteries from over-discharging. 
	</P>
	<LI><P CLASS="western">Additional 2-pin terminal for an external
	battery charger (this is just a gate, all charging functionality
	depends on the charger itself) 
	</P>
	<LI><P CLASS="western">On-board LED indicators and on screen Linux
	system notifications 
	</P>
	<LI><P CLASS="western">Configuration of multiple battery chemistries
	and number of cells from a UI on the Pi 
	</P>
	<LI><P CLASS="western">Full API in Python, plus a shell-friendly
	command-line interface 
	</P>
	<LI><P CLASS="western">Very low-profile (3.5 mm), bottom entry,
	40-pin GPIO connector allowing stacking of other boards on top of
	the MoPi-2 
	</P>
	<LI><P CLASS="western">PCB pads for external power switch and +5V 
	</P>
	<LI><P CLASS="western">Control of external 5V relay</P>
	<LI><P CLASS="western">Two-way communication via the I<SUP>2</SUP>C
	bus 
	</P>
	<LI><P CLASS="western">Remote power-off: tell MoPi-2 to power down
	the Pi when logged-in remotely (after a clean shutdown, of course) 
	</P>
	<LI><P CLASS="western">Timer-based wake-up: tell MoPi-2 what time
	you want your Pi to wakeup, then power it down and MoPi-2 will boot
	the Pi as requested 
	</P>
	<LI><P CLASS="western">Supports Raspberry Pi 2, Raspberry Pi 3 and
	Raspberry Pi 3 B+ models. 
	</P>
</UL>
<H1 CLASS="western"><A NAME="__RefHeading__5508_902516158"></A>2.User
Guide 
</H1>
<H2 CLASS="western"><A NAME="__RefHeading__5510_902516158"></A>2.1.Warnings!!!
</H2>
<UL>
	<LI><P CLASS="western">DO NOT plug MoPi-2 onto your Pi while the Pi
	is powered up! 
	</P>
	<LI><P CLASS="western">DO NOT touch electronic components when
	they're powered up &mdash; you may damage them, or burn your
	fingers! 
	</P>
	<LI><P CLASS="western">AVOID handling circuit boards when charged
	with static! 
	</P>
	<LI><P CLASS="western">ALWAYS read the small print on all components
	supplied with your MoPi-2 
	</P>
	<LI><P CLASS="western">ALWAYS treat batteries and other power
	supplies with respect &mdash; if abused the energy they contain may
	surprise you in dangerous ways! 
	</P>
	<LI><P CLASS="western">DO NOT feed MoPi-2 to your dog, eat nuts if
	you're allergic to them, or lose your sense of humor.</P>
</UL>
<H2 CLASS="western"><A NAME="__RefHeading__1997_1477197617"></A><A NAME="2.2.The MoPi-2|outline"></A><A NAME="2.2.The MoPi-2|outline"></A><A NAME="2.2.The MoPi-2|outline"></A>
2.2.Delivery Kit 
</H2>
<P CLASS="western">The MoPi-2 is delivered in small cartoon box. Its
contents is shown below. On the sides of the box is printed a link to
the website containing this manual. On the underside of the box there
is a QR code pointing to the same site. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; line-height: 100%"><IMG SRC="images/MoPi-2_Kit.jpg" NAME="графики19" ALIGN=LEFT WIDTH=309 HEIGHT=223 BORDER=0><BR CLEAR=LEFT><BR>
</P>
<H2 CLASS="western"><A NAME="__RefHeading__2189_1069455434"></A>2.3.MoPi-2
LEDs and Connectors</H2>
<P CLASS="western" STYLE="margin-bottom: 0cm; line-height: 100%">The
MoPi-2 top side is shown on the picture below. Description follows. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; line-height: 100%"><IMG SRC="images/MoPi-2_Top.jpg" NAME="графики6" ALIGN=LEFT WIDTH=423 HEIGHT=423 BORDER=0><BR CLEAR=LEFT><BR>
</P>
<UL>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><B>X1</B></FONT></FONT>
	  &ndash;  screw terminal for external charger. Pin #1 is live wire
	(typically red), pin #2 is ground wire (typically black). 
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><B>X2</B></FONT></FONT>
	  &ndash;  screw terminal for power sources. Pin #1 is for live wire
	of power source #1 (typically red), pin #3 is for live wire of power
	source #2 (typically red), and pin #2 is for ground wires of both
	sources (typically black). 
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><B>X3</B></FONT></FONT>
	  &ndash;  GPIO connector. The PCB has holes for all 40 pins, while
	the connector itself, located on the bottom side of the PCB, takes
	the first 34 pins only. The pin #1 is marked with small square. 
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><B>D7</B></FONT></FONT>
	  &ndash;  RGB status LED. Indicates<SPAN LANG="en-US"> the actual
	voltage level of the power source. Blue light means battery full,
	green light means battery good, red light means battery low
	(discharged), flashing red light shows that shutdown is in progress.
	</SPAN>
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><SPAN LANG="en-US"><B>D8</B></SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=4><SPAN LANG="en-US">,</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">
	</SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=4><SPAN LANG="en-US"><B>D9</B></SPAN></FONT></FONT><SPAN LANG="en-US">
	  &ndash;  two green LEDs showing the power sources status, </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">D8</SPAN></FONT></FONT><SPAN LANG="en-US">
	for source #1, </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">D9</SPAN></FONT></FONT><SPAN LANG="en-US">
	for source #2. Steady light means battery full, flashing light means
	battery discharged, light off means battery not connected. </SPAN>
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><SPAN LANG="en-US"><B>D10</B></SPAN></FONT></FONT><SPAN LANG="en-US">
	  &ndash;   green LED showing the charger gate status. Steady light
	means the gate is open, otherwise the gate is closed. </SPAN><SPAN LANG="en-US"><I>The
	battery connected as source #2 can be charged only when the gate is
	open. </I></SPAN>
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><SPAN LANG="en-US"><B>D11</B></SPAN></FONT></FONT><SPAN LANG="en-US">
	  &ndash;   flashing red LED showing high power consumption (close
	to 2.5A or higher). It is off at lower consumption. </SPAN>
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><SPAN LANG="en-US"><B>SW1</B></SPAN></FONT></FONT><SPAN LANG="en-US">
	  &ndash;   power switch. Pressed for 2 seconds turns MoPi on,
	pressed for 3 seconds starts MoPi shutdown. Pressed for 10 seconds
	turns MoPi immediately off.</SPAN></P>
	<LI><P CLASS="western"> <FONT FACE="Courier New, monospace"><FONT SIZE=4><SPAN LANG="en-US"><B>EXT.SW</B></SPAN></FONT></FONT><SPAN LANG="en-US">
	  &ndash;   soldering pads for external power switch. </SPAN>
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=4><SPAN LANG="en-US"><B>EXT.RLY</B></SPAN></FONT></FONT><SPAN LANG="en-US">
	  &ndash;   soldering pads for external 5V relay. </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">+5V</SPAN></FONT></FONT><SPAN LANG="en-US">
	is for live wire, </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">GND</SPAN></FONT></FONT><SPAN LANG="en-US">
	is for ground wire. </SPAN>
	</P>
</UL>
<H2 CLASS="western"><A NAME="__RefHeading__5512_902516158"></A>2.4.Installation
and Use 
</H2>
<H3 CLASS="western"><A NAME="__RefHeading__5514_902516158"></A><A NAME="2.2.1.Quick Start |outline"></A>
2.4.1.Quick Start 
</H3>
<P CLASS="western">If you are in hurry: 
</P>
<P CLASS="western" STYLE="margin-left: 0.64cm; margin-bottom: 0.2cm; line-height: 100%">
1. Install the battery monitoring software and shutdown:</P>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=3>sudo apt-get update</FONT></FONT></P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">sudo
	apt-get install simbamond</SPAN></FONT></FONT><A HREF="#Footnote2"><SUP><SPAN LANG="en-US">2</SPAN></SUP></A></P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=3>sudo
	poweroff</FONT></FONT> 
	</P>
</UL>
<P CLASS="western" STYLE="margin-left: 0.64cm">2. Connect your
batteries and charger to the MoPi-2</P>
<P CLASS="western" STYLE="margin-left: 0.64cm">3. Attach the MoPi-2
to your Raspberry Pi and press the Power Switch for 2 seconds 
</P>
<P CLASS="western">For more details on each step, see below. 
</P>
<H3 CLASS="western"><A NAME="__RefHeading__5516_902516158"></A>2.4.2.Installing
the Software 
</H3>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">As
noted above, you can install the battery monitoring software like
this:</P>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=3>sudo apt-get update</FONT></FONT></P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">sudo
	apt-get install simbamond</SPAN></FONT></FONT><A HREF="#Footnote2"><SUP><SPAN LANG="en-US">2</SPAN></SUP></A></P>
</UL>
<P CLASS="western"><SPAN LANG="en-US">(We assume you're using the
</SPAN><A HREF="http://www.raspbian.org/">Raspbian flavour</A><SPAN LANG="en-US">
of </SPAN><A HREF="http://debian.org/">Debian</A><SPAN LANG="en-US">
GNU Linux here.)</SPAN></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">Occasionally
this method may cause glitches (if you've a very old version of the
rest of the operating system installed, for example). The most
cautious recipe is to update your firmware and the operating system,
then install the MoPi-2 software, and to reboot between each step: 
</P>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=3>sudo apt-get update</FONT></FONT>
		</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=3>sudo apt-get
	upgrade</FONT></FONT> 
	</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=4><FONT SIZE=3>sudo
	reboot</FONT> </FONT></FONT>
	</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT SIZE=3><FONT FACE="Courier New, monospace">sudo rpi-update</FONT>
	</FONT>
	</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=3>sudo reboot </FONT></FONT>
	</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=4><FONT SIZE=3>sudo
	apt-get install simbamond</FONT><A HREF="#Footnote2"><SUP>2</SUP></A></FONT></FONT></P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">
	<FONT FACE="Courier New, monospace"><FONT SIZE=4><FONT SIZE=3>sudo
	poweroff</FONT> </FONT></FONT>
	</P>
</UL>
<P CLASS="western">Note that if you're installing the software
without MoPi-2 attached, or without power attached to MoPi-2, you
will get a warning message5; just ignore it at this point! 
</P>
<H3 CLASS="western"><A NAME="__RefHeading__5518_902516158"></A>2.4.3.Connecting
the Power and the Charger</H3>
<P CLASS="western">Next connect one or more power supply to MoPi-2
using the screw terminals <FONT FACE="Courier New, monospace"><FONT SIZE=3>X2</FONT></FONT>
on the topside of the board. When connecting the power sources (e.g.
two battery packs, or one solar panel and one battery pack) follow
the <A HREF="#2.2.The MoPi-2|outline">above description</A> and the
picture below. The same concerns the external charger, if use.</P>
<H3 CLASS="western" STYLE="margin-top: 0cm; margin-bottom: 0cm; page-break-before: auto; page-break-after: auto">
<IMG SRC="images/Connections.JPG" NAME="графики7" ALIGN=LEFT WIDTH=464 HEIGHT=348 BORDER=0><BR CLEAR=LEFT></H3>
<H3 CLASS="western"><A NAME="__RefHeading__2003_1069455434"></A>2.4.4.Connecting
to the Raspberry Pi  
</H3>
<P CLASS="western">Gently push fit MoPi-2 onto your Raspberry Pi's
GPIO pins. Make sure you do this with the Raspberry Pi turned off, or
you risk a reset. Please note that MoPi-2 connector has 3<SPAN LANG="bg-BG">4</SPAN>
pins, not 40, and it must be left aligned with the Pi connector,
matching both pins #1. 
</P>
<TABLE WIDTH=100% BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=128*>
	<COL WIDTH=128*>
	<TR VALIGN=TOP>
		<TD WIDTH=50%>
			<P CLASS="western"><IMG SRC="images/MoPi+Pi_Front.JPG" NAME="графики10" ALIGN=LEFT HSPACE=9 WIDTH=309 HEIGHT=232 BORDER=0><BR CLEAR=LEFT><BR>
			</P>
		</TD>
		<TD WIDTH=50%>
			<P CLASS="western" ALIGN=RIGHT><IMG SRC="images/MoPi+Pi_Back.JPG" NAME="графики8" ALIGN=LEFT HSPACE=9 VSPACE=32 WIDTH=309 HEIGHT=118 BORDER=0><BR CLEAR=LEFT><BR>
			</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">If you want to use
MoPi-2 in combination with another Pi add-on board you need 
</P>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm"><SPAN LANG="en-US">to
	buy one 2x20-pins extra-long GPIO connector (e.g. by </SPAN><A HREF="https://www.adafruit.com/product/2223">Adafruit</A><SPAN LANG="en-US">)
	and push this connector fit onto your Raspberry Pi GPIO pins </SPAN>
	</P>
</UL>
<TABLE WIDTH=100% BORDER=0 CELLPADDING=4 CELLSPACING=0>
	<COL WIDTH=128*>
	<COL WIDTH=128*>
	<TR VALIGN=TOP>
		<TD WIDTH=50%>
			<P CLASS="western"><IMG SRC="images/Connector2223.jpg" NAME="графики15" ALIGN=LEFT WIDTH=291 HEIGHT=218 BORDER=0><BR CLEAR=LEFT><BR>
			</P>
		</TD>
		<TD WIDTH=50%>
			<P CLASS="western"><IMG SRC="images/Conn2223+Pi.jpg" NAME="графики16" ALIGN=LEFT WIDTH=300 HEIGHT=225 BORDER=0><BR CLEAR=LEFT><BR>
			</P>
		</TD>
	</TR>
</TABLE>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm">push fit MoPi-2
	onto the connector, and 
	</P>
	<TABLE WIDTH=100% BORDER=0 CELLPADDING=4 CELLSPACING=0>
		<COL WIDTH=128*>
		<COL WIDTH=128*>
		<TR VALIGN=TOP>
			<TD WIDTH=50%>
				<P CLASS="western"><IMG SRC="images/MoPi_Stacked_Front1.jpg" NAME="графики11" ALIGN=LEFT WIDTH=311 HEIGHT=149 BORDER=0><BR CLEAR=LEFT><BR>
				</P>
			</TD>
			<TD WIDTH=50%>
				<P CLASS="western"><IMG SRC="images/MoPi_Stacked_Back1.jpg" NAME="графики12" ALIGN=LEFT WIDTH=312 HEIGHT=146 BORDER=0><BR CLEAR=LEFT><BR>
				</P>
			</TD>
		</TR>
	</TABLE>
	<LI><P CLASS="western">push the other board to fit on top. 
	</P>
</UL>
<TABLE WIDTH=100% BORDER=0 CELLPADDING=0 CELLSPACING=0>
	<COL WIDTH=128*>
	<COL WIDTH=128*>
	<TR VALIGN=TOP>
		<TD WIDTH=50%>
			<P CLASS="western"><IMG SRC="images/MoPi_Stacked_Front2.jpg" NAME="графики13" ALIGN=LEFT WIDTH=321 HEIGHT=154 BORDER=0><BR CLEAR=LEFT><BR>
			</P>
		</TD>
		<TD WIDTH=50%>
			<P CLASS="western" ALIGN=LEFT><IMG SRC="images/MoPi_Stacked_Back2.jpg" NAME="графики14" ALIGN=LEFT WIDTH=301 HEIGHT=182 BORDER=0><BR CLEAR=LEFT><BR>
			</P>
		</TD>
	</TR>
</TABLE>
<P CLASS="western">(An empty MoPi-2 board has been used as example
for second add-on board). 
</P>
<P CLASS="western">If the other add-on board has an extra-long
connector, then it can be connected to the Pi and MoPi-2 stacked on
top of it. 
</P>
<P CLASS="western"><SPAN LANG="en-US"><I><B>Note:</B></I></SPAN><SPAN LANG="en-US">
MoPi-2 should be compatible with all Pi add-on boards, as it only use
the I</SPAN><SUP><SPAN LANG="en-US">2</SPAN></SUP><SPAN LANG="en-US">C
bus, which supports the connection of multiple devices.</SPAN></P>
<H3 CLASS="western"><A NAME="__RefHeading__5520_902516158"></A>2.4.5.Turn
On, Turn Off 
</H3>
<P CLASS="western"><SPAN LANG="en-US">When MoPi-2 and the Pi are
powered off, press the power switch for 2 seconds to turn them on.</SPAN><A HREF="#Footnote3"><SUP><SPAN LANG="en-US">3</SPAN></SUP></A><SPAN LANG="en-US">
</SPAN>
</P>
<P CLASS="western">When the Pi is powered on, press the power switch
for 3 seconds to turn it off. This will shut the Pi down cleanly
(which can take up to around 30 seconds). If you hold the power
switch down for 10 seconds, the power will shut down immediately. 
</P>
<H3 CLASS="western" STYLE="page-break-before: auto"><A NAME="__RefHeading__2007_1692238003"></A>
2.4.6.Connecting External Power Switch and/or Relay (Optional) 
</H3>
<P CLASS="western">In case of need of external (remote) power switch,
it has to be soldered to the two pads labeled <A HREF="#2.2.The MoPi-2|outline"><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US"><SPAN STYLE="font-weight: normal">EXT.SW</SPAN></SPAN></FONT></FONT></A>.
See the next picture. 
</P>
<P CLASS="western"><IMG SRC="images/MoPi+ExtButton.jpg" NAME="графики17" ALIGN=LEFT WIDTH=386 HEIGHT=290 BORDER=0><BR CLEAR=LEFT><BR><BR>
</P>
<P CLASS="western">In case of huge power load, bigger than the MoPi-2
is able to take, an external 5V, e.g. 10A relay is needed. It has to
be soldered to the pads labeled <A HREF="#2.2.The MoPi-2|outline"><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN STYLE="font-weight: normal">EXT.RLY</SPAN></FONT></FONT></A>.
Follow the pads polarity and the picture below. The electrical
diagram of the relay circuit is also given below. 
</P>
<P CLASS="western" STYLE="margin-bottom: 0cm; line-height: 100%"><IMG SRC="images/MoPi+ExtRelay.jpg" NAME="графики18" ALIGN=LEFT WIDTH=341 HEIGHT=254 BORDER=0><BR CLEAR=LEFT><BR>
</P>
<P CLASS="western"><IMG SRC="images/MoPi%20High-Current.jpg" NAME="графики20" ALIGN=LEFT WIDTH=512 HEIGHT=228 BORDER=0><BR CLEAR=LEFT>A
5V 10A relay and a rectifier are soldered to the <FONT FACE="Courier New, monospace"><FONT SIZE=3>EXT.RLY</FONT></FONT>
pads. Note both polarity. If MMELF case is used, the rectifier fits
exactly on the pads (see the white oval on the above picture). Then
MoPi-2 is fit on the Pi via the GPIO connector. An additional
DC-to-DC converter, e.g. 3A UBEC, as added to power the external load
trough the relay contacts. Thus the load will be powered on and off
in parallel with the Pi, under MoPi control.  
</P>
<H2 CLASS="western"><A NAME="__RefHeading__5522_902516158"></A>2.5.Choosing
and Configuring Batteries (Etc.)</H2>
<P CLASS="western">The short story is this:</P>
<UL>
	<LI><P CLASS="western"><SPAN LANG="en-US">Any power supply connected
	to the MoPi-2 must be capable of at least 6.5V under load, and no
	more than 24V.</SPAN><A HREF="#Footnote1"><SUP><SPAN LANG="en-US">1</SPAN></SUP></A></P>
	<LI><P CLASS="western">The MoPi-2 must be configured correctly both
	to avoid damage to rechargeable batteries and to avoid unexpected
	shutdowns! 
	</P>
</UL>
<P CLASS="western">How do I configure MoPi-2? There are 3 ways: 
</P>
<P CLASS="western" STYLE="margin-left: 0.64cm">1. Use the on-board
default &mdash; easy peasy! 
</P>
<P CLASS="western" STYLE="margin-left: 0.64cm">2. Use the
Configuration Tool<A HREF="#Footnote4"><SUP>4</SUP></A> on your Pi &mdash;
straightforward. 
</P>
<P CLASS="western" STYLE="margin-left: 0.64cm">3. Use the
command-line interface, and/or edit the daemon config data on your Pi
&mdash; advanced. 
</P>
<P CLASS="western">Let's take each of these in turn... 
</P>
<H3 CLASS="western"><A NAME="__RefHeading__5524_902516158"></A><A NAME="2.3.1.Choosing Default Supply Profile |outline"></A>
2.5.1.Choosing Default Supply Profile 
</H3>
<P CLASS="western">The default supply profile is eight NiMH AA
rechargeable batteries.</P>
<H3 CLASS="western"><A NAME="__RefHeading__5526_902516158"></A><A NAME="2.3.2.Using the Configuration Tool on the Pi |outline"></A><A NAME="2.3.2.Using the Configuration Tool on the Pi |outline"></A>
2.5.2.Using the Configuration Tool on the Pi 
</H3>
<P CLASS="western">If you're using a supply that doesn't match
MoPi-2's default profile, you need to run a configuration utility on
the Pi itself. This will prompt you to enter details of the supply,
then calculate appropriate values to send to the board over I2C. It
will also store the config data and resend it to the board after
reboots as necessary.</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">To start the
configuration tool open a terminal and do: 
</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.2cm"><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">sudo
mopi</SPAN></FONT><SPAN LANG="en-US"> </SPAN>
</P>
<P CLASS="western"><SPAN LANG="en-US">The tool operates in the same
way as the Raspberry Pi's configuration tool (</SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">raspi-config</SPAN></FONT><SPAN LANG="en-US">).
Select the option to configure one or both of MoPi-2's supplies, and
then: </SPAN>
</P>
<UL>
	<LI><P CLASS="western"><SPAN LANG="en-US"><I>Type of supply</I></SPAN><SPAN LANG="en-US">.
	This is one of </SPAN><SPAN LANG="en-US"><B>rechargeable battery</B></SPAN><SPAN LANG="en-US">,
	</SPAN><SPAN LANG="en-US"><B>non-rechargeables</B></SPAN><SPAN LANG="en-US">
	(like standard Alkaline batteries), or </SPAN><SPAN LANG="en-US"><B>non-battery</B></SPAN><SPAN LANG="en-US">
	(like an AC adapter). </SPAN>
	</P>
	<LI><P CLASS="western"><SPAN LANG="en-US"><I>Number of cells</I></SPAN><SPAN LANG="en-US">.
	This is the </SPAN><SPAN LANG="en-US"><B>number of individual
	battery cells</B></SPAN><SPAN LANG="en-US"> in your supply. Note
	that some batteries incorporate several cells &mdash; e.g. a9V PP3
	has 6 cells internally.</SPAN></P>
	<LI><P CLASS="western"><SPAN LANG="en-US"><I>Battery chemistry</I></SPAN><SPAN LANG="en-US">.
	The </SPAN><SPAN LANG="en-US"><B>type of battery</B></SPAN><SPAN LANG="en-US">
	you're connecting. For example &quot;Alkaline&quot; or &quot;NiMH&quot;
	or &ldquo;Li-Ion&rdquo; or &quot;N/A&quot; for non-battery supplies.
	</SPAN>
	</P>
</UL>
<P CLASS="western"><SPAN LANG="en-US">After entering this data the
tool will give details of the values it has calculated and offer to
write these to the MoPi-2 board. There is detail of </SPAN><A HREF="#4.4.Configuring Your Power Supplies |outline">these
values and how the tool works</A><SPAN LANG="en-US"> below.</SPAN></P>
<H3 CLASS="western"><A NAME="__RefHeading__5528_902516158"></A>2.5.3.Command
Line, Python API and Daemon Config Hacking 
</H3>
<P CLASS="western"><SPAN LANG="en-US">Finally, if you want more
control, or the other methods are insufficiently scary, you can use
</SPAN><A HREF="#4.3.MoPi-2 from the Command Line |outline">the
command-line tool</A><SPAN LANG="en-US"> directly, or edit </SPAN><A HREF="#4.6.simbamon: a simple battery monitor |outline">the
simbamon daemon</A><SPAN LANG="en-US"> configuration data, or write
code using the </SPAN><A HREF="#4.2.The Python API |outline">Python
API</A><SPAN LANG="en-US">.</SPAN></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">A quick demo of using
the cli setting the default 8 NiMH profile:</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.2cm"><FONT FACE="Courier New, monospace">sudo
mopicli -wc 1 11200 9800 9350 8500 </FONT>
</P>
<P CLASS="western"><SPAN LANG="en-US">For more details, see </SPAN><A HREF="#4.The MoPi-2 Software Suite |outline">the
software</A><SPAN LANG="en-US"> below.</SPAN></P>
<H3 CLASS="western"><A NAME="__RefHeading__5530_902516158"></A>2.5.4.Minimum
Number of Cells</H3>
<P CLASS="western">The minimum number of battery cells that have to
be used to power the MoPi-2 depends on the battery chemistry.
Different battery cells have different voltage level, hence different
minimum number of cells. Below are given the minimal number of cells
for each battery chemistry. 
</P>
<TABLE WIDTH=100% BORDER=1 BORDERCOLOR="#000000" CELLPADDING=4 CELLSPACING=0 STYLE="page-break-inside: avoid">
	<COL WIDTH=64*>
	<COL WIDTH=64*>
	<COL WIDTH=64*>
	<COL WIDTH=64*>
	<TR>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm"><B>Battery
			Type</B></P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm"><B>Single
			Cell Voltage</B></P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm"><B>Number
			of Cells</B></P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm"><B>Total
			Voltage</B></P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">NiMH</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">1.2 V</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">6</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">7.2 V</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">Li-Ion</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">3.6 V</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">2</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">7.2 V</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">LiPo</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">3.7 V</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">2</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">7.4 V</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">LiFePO4</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">3.3 V</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">3</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">9.9 V</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">Alkaline</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">1.4 V</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">5</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">7.0 V</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">Lead
			Acid</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">2.0 V</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">4</P>
		</TD>
		<TD WIDTH=25%>
			<P CLASS="western" ALIGN=CENTER STYLE="margin-top: 0.1cm">8.0 V</P>
		</TD>
	</TR>
</TABLE>
<H2 CLASS="western" STYLE="margin-top: 0.8cm"><A NAME="__RefHeading__5532_902516158"></A>
2.6.Troubleshooting and FAQ 
</H2>
<H3 CLASS="western"><A NAME="__RefHeading__5534_902516158"></A>2.6.1.Wh...?
</H3>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; Which
GPIO pins does MoPi-2 use?</B></P>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">
	Pins 2 and 4: 5V out</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">
	pins 3 and 5: I<SUP>2</SUP>C bus 
	</P>
	<LI><P CLASS="western">pin 6 and any other grounded pin: 0V. 
	</P>
</UL>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; I get a
warning during software installation </B>
</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">If you're installing
the software without MoPi-2 attached to the Pi, or MoPi-2 off, you
will get this warning message: 
</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm"><FONT FACE="Courier New, monospace">/usr/sbin/simbamon:
/usr/sbin/mopicli not working; MoPi-2 not attached or powered?
(mopicli. I2C bus input/output error on read word. Check bus? Check
connection?) </FONT>
</P>
<P CLASS="western">In this case you can safely ignore it. 
</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; How do I
connect another board? </B>
</P>
<P CLASS="western"><SPAN LANG="en-US">If you want to use MoPi-2 in
combination with another Pi add-on board you need a) to buy one
40-pin extra-toll GPIO connector (e.g. Adafruit &hellip;...), b)
gently push this connector fit </SPAN><SPAN LANG="en-US">onto your
Raspberry Pi's GPIO pins, c)  gently push fit MoPi-2 onto the
connector, and d) push the other board to fit on top. See the
picture. </SPAN>
</P>
<P CLASS="western">If the other add-on board has an extra-toll
connector, then it can be connected to the Pi and MoPi-2 stack on top
of it. 
</P>
<P CLASS="western">MoPi-2 should be compatible with all other Pi
add-on boards, as we only use the I<SUP>2</SUP>C bus, which supports
the connection of multiple devices.</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; I
connected a power source, press the switch but MoPi-2 won't start...?</B></P>
<P CLASS="western">MoPi-2 needs a minimum of 6.5 volts to run. Then
it also has a (configurable) &quot;safe depth of discharge&quot;
setting to prevent damage to rechargeable batteries. If the sources
connected aren't higher than the highest of these, MoPi-2 will refuse
to power the Pi. If there is enough voltage to run the
microcontroller, it will blink the relevant green LED a few times to
signal the problem.</P>
<P CLASS="western">Solutions:</P>
<UL>
	<LI><P CLASS="western"><A HREF="#4.4.Configuring Your Power Supplies |outline">Configure
	the MoPi-2</A> to accept the supply (if it will reliably exceed 6.5
	volts under load). 
	</P>
	<LI><P CLASS="western">If it still doesn't start, the batteries may
	be discharged! Connect some freshly charged ones or a higher voltage
	supply. 
	</P>
</UL>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; What
type of regulator chip is it? What is the voltage range?</B></P>
<P CLASS="western">MoPi-2 uses TPS5430DDA 3A step-down voltage
converter. The input voltage range is specified as 6.5V to 24V.
There's no step-up circuitry so the battery or solar panel rig or
etc. has to supply 6.5V at minimum. Consider connecting multiple
batteries or panels in series to increase voltage. 
</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; Can I
access the voltage data on MoPi-2 from the Pi?</B></P>
<P CLASS="western">Yes!</P>
<P CLASS="western">The software on the Pi that talks to MoPi-2,
simbamond, is open source and available here:
<A HREF="https://github.com/hamishcunningham/pi-tronics/tree/master/simbamon">https://github.com/hamishcunningham/pi-tronics/tree/master/simbamon</A>
(See also <A HREF="http://pi.gate.ac.uk/pages/download.html">http://pi.gate.ac.uk/pages/download.html</A>.)
The Raspbian maintainers have added simbamond to their repository, so
you can install it in the same way as any other Pi software.</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">Simbamond listens to
MoPi-2 and logs the data in a standard manner, which other
applications can then consume as required. There's also a Python API
and a command-line interface (CLI):</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.2cm"><FONT FACE="Courier New, monospace">sudo
mopicli -v -v1 -v2</FONT></P>
<P CLASS="western">For more details, see <A HREF="#4.The MoPi-2 Software Suite |outline">the
software</A> below.</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; Can I
combine mains and solar power?</B></P>
<P CLASS="western">Yes!</P>
<P CLASS="western">This should work so long as you connect the
mains-derived power to one of MoPi-2's inputs (it will have to be a
supply &gt;= 6.5 volts). MoPi-2 will then use mains whenever the
solar output dips below the mains supply. The ideal would be a solar
panel rig that outputs e.g. 15V coupled with a 12V mains supply, or
some similar config.</P>
<P CLASS="western">Note also that the Pi will draw significant
current, depending on the model and the peripherals, and you will
needs sufficient panels (and sunshine!) to generate the requisite
power. As a very rough guide, we've had some success with three 10W
panels running a model B (without peripherals).</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; How do
we avoid deep discharge of rechargeables?</B></P>
<P CLASS="western">The short answer it to shutdown before it happens.
Rechargeable batteries don't like being completely discharged. We
always need to stop drawing from the battery at some distance above
some minimum voltage level. This level varies for different battery
chemistries (NiMH, LiPo, lead/acid, etc.) and for different numbers
of cells (eight AAs vs. two PP3s vs. one car battery, etc.).</P>
<P CLASS="western">MoPi-2 listens continuously to the voltage level
on the battery inputs. How does it know when that level is getting
low? Let's identify two separate low-level points: first, the
absolute low voltage level is the point where our micro-controller
can no longer reliably run the switching regulator to produce a
constant 5V (around 6.5 volts). The second low voltage (critical)
point is just above the deep discharge level, which depends on the
batteries attached. When you use <A HREF="#2.3.2.Using the Configuration Tool on the Pi |outline">the
configuration tool</A> this critical voltage point sent to the
MoPi-2. As long as you've correctly configured your batteries, we
should be avoiding deep discharge.</P>
<P CLASS="western">When the MoPi-2 decides the input voltage is
critical (for either or both of its two supplies), simbamond warns
the user and shuts down the Pi cleanly (from software first, using
&quot;sudo halt&quot;, and then by cutting power). How do we decide
when to do this, that is to say, how do we pick the critical voltage
level? We've done some research on batteries. For eight NiMH 1.2 volt
cells the critical voltage is around 8.5 volts. For
non-rechargeables, or solar panels or a water turbine, it is the same
as the absolute low level (6.5V) as these can't suffer deep
discharge.</P>
<P CLASS="western">The critical voltage level is kind of short notice
though for replacing batteries. The configuration tool also specifies
a low voltage level, which is when the LED on the MoPi-2 turns red
and you start receiving low battery notifications. This is set to be
1.1*critical, so for 8 AA NiMH batteries it's 9.3 volts. (There are
other voltage levels defined too. Read more <A HREF="#4.4.Configuring Your Power Supplies |outline">later</A>.)</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><A NAME="faq-mkmod-error"></A>
<B>&gt;&gt;&gt; Mkmod or libkmod errors when installing or upgrading.</B></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">The installation of
simbamond requires enabling I<SUP>2</SUP>C. If it is not enabled by
default, there are two ways to do this, depending on what version of
Raspbian we're running. At present the installation script tries to
do both, with the intention of catering for the maximum number of
variants. This does mean that you may see errors like the following.
If everything works after a reboot, ignore them; otherwise:</P>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm">try installing
	<FONT FACE="Courier New, monospace">i2c-tools</FONT> and <FONT FACE="Courier New, monospace">i2cdetect</FONT>
	to see if the bus is enabled 
	</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm"><FONT FACE="Courier New, monospace">i2cdetect
	-l </FONT>will return nothing if I<SUP>2</SUP>C is not enabled, or
	something like &quot;<FONT FACE="Courier New, monospace">i2c-1
	unknown ...</FONT>&quot; if it is enabled 
	</P>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm"><A HREF="https://github.com/hamishcunningham/pi-tronics/issues">raise
	an issue</A>. 
	</P>
</UL>
<P CLASS="western" STYLE="margin-bottom: 0.1cm">If you get a message
like 
</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm">&quot;<FONT FACE="Courier New, monospace">libkmod:
ERROR ../libkmod/libkmod.c:554 kmodsearchmoddep: could not open
moddep file '/lib/modules/3.6.11+/modules.dep.bin</FONT>'&quot; 
</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">when installing, try
a reboot followed by 
</P>
<P CLASS="western" STYLE="margin-left: 1.27cm"><FONT FACE="Courier New, monospace">sudo
apt-get -f install</FONT></P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; The I<SUP>2</SUP>C
bus doesn't work after install.</B></P>
<P CLASS="western">If the I<SUP>2</SUP>C bus appears not to be
working after installing simbamon, try a reboot. Sometimes the Python
SMBus module appears not to load correctly. 
</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; How do I
add a remote power switch?</B></P>
<P CLASS="western">There's a description <A HREF="#2.3.4.Connecting External Power Button and/or Relay (Optional) |outline">here</A>.</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; How do I
add a<SPAN LANG="en-US">n</SPAN> external 5V relay?</B></P>
<P CLASS="western">There's a description <A HREF="#2.3.4.Connecting External Power Button and/or Relay (Optional) |outline">here</A>.</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; What do
the status bits mean?</B></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">MoPi-2 returns status
data to the Pi over i2C &mdash; if you need to interpret these:</P>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.2cm"><FONT FACE="Courier New, monospace">mopicli</FONT><FONT FACE="Arial, sans-serif">
	</FONT><FONT FACE="Courier New, monospace">-sv</FONT> will give you
	the decoded status 
	</P>
	<LI><P CLASS="western"><A HREF="https://github.com/hamishcunningham/pi-tronics/blob/master/simbamon/simbamond.default">check
	the source code</A> to see the meaning of each bit.</P>
</UL>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; How can
I read the MoPi serial number?</B></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">Type <FONT FACE="Courier New, monospace"><FONT SIZE=3>sudo</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>mopicli</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>-sn</FONT></FONT>
and you will get the device serial number:</P>
<P CLASS="western">	<FONT FACE="Courier New, monospace"><FONT SIZE=3>Serial</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>number:</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>XXXX</FONT></FONT>
</P>
<P CLASS="western" STYLE="margin-top: 0.2cm"><B>&gt;&gt;&gt; How do I
...?</B></P>
<P CLASS="western">Another good place to look is the <A HREF="https://github.com/hamishcunningham/pi-tronics/issues">GitHub
issues list</A> (click on the &quot;closed&quot; list to see them
all).</P>
<P CLASS="western">If you're still stuck, raise a new issue?</P>
<P CLASS="western">Good luck!</P>
<H3 CLASS="western"><A NAME="__RefHeading__5536_902516158"></A>2.6.2.Pi
Models: 2, 3, 3 B+ 
</H3>
<P CLASS="western">MoPi-2 is tested and is working fine with the
Raspberry Pi 2 Model B, Pi 3 Model B and Pi 3 Model B+. See <A HREF="#2.2.5.How to Use MoPi-2  |outline">above</A>.
</P>
<H1 CLASS="western"><A NAME="__RefHeading__5538_902516158"></A>3.The
MoPi-2 Hardware 
</H1>
<P CLASS="western">The MoPi-2 simplified schematic diagram is shown
below.</P>
<H2 CLASS="western" STYLE="margin-top: 0cm; margin-bottom: 0cm; font-style: normal; font-weight: normal">
<IMG SRC="images/MoPi-2_Sch.jpg" NAME="графики5" ALIGN=LEFT WIDTH=398 HEIGHT=696 BORDER=0><BR CLEAR=LEFT></H2>
<H2 CLASS="western"><A NAME="__RefHeading__5540_902516158"></A><A NAME="3.1.simbamond, the simbamon daemon|outline"></A>
3.1.Powering the Pi 
</H2>
<P CLASS="western"><SPAN LANG="en-US">MoPi-2 has two power inputs,
labeled </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">BATTERY</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">
</SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">#1</SPAN></FONT></FONT><SPAN LANG="en-US">
and </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">BATTERY</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">
</SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">#2</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">
(connector </SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">X2</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">,
pin </SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">#1</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">
and pin </SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">#3</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">
respectively; pin </SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">#2</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">
is </SPAN></FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">GND</SPAN></FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3><SPAN LANG="en-US">).
They</SPAN></FONT></FONT><SPAN LANG="en-US"> are connected to MOSFET
switches </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">T4</SPAN></FONT></FONT><SPAN LANG="en-US">
and </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">T6</SPAN></FONT></FONT><SPAN LANG="en-US">
respectively. The </SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">T5</SPAN></FONT><SPAN LANG="en-US">
and </SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">T7</SPAN></FONT><SPAN LANG="en-US">
comparators open this switch whose input voltage is higher. The
corresponding green LED, </SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">D8</SPAN></FONT><SPAN LANG="en-US">
or </SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">D9</SPAN></FONT><SPAN LANG="en-US">,
located next to the power inputs, lights up. The other input voltage,
if such exists, is backing up the MoPi-2 work and takes over
immediately after the first input voltage becomes lower than the
second one.</SPAN></P>
<P CLASS="western"><SPAN LANG="en-US">The +5 volts to the Pi is
generated by a highly efficient, wide-input, 3A switch mode voltage
converter </SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">U3</SPAN></FONT><SPAN LANG="en-US">.
It starts when the power switch </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">SW1</SPAN></FONT></FONT><SPAN LANG="en-US">
is pressed and hold for 2 </SPAN><SPAN LANG="en-US">seconds. Between
U3 output and GPIO connector pins a &ldquo;smart diode&rdquo; T10 is
placed to protect Pi and MoPi-2 from opposite switching of their
power supplies. </SPAN>
</P>
<P CLASS="western"><SPAN LANG="en-US">The MoPi-2 functionality is
implemented by a firmware flashed in microcontroller. It does voltage
level monitoring, level signaling (via the LEDs and the I</SPAN><SUP><SPAN LANG="en-US">2</SPAN></SUP><SPAN LANG="en-US">C
interface), and on/off switching of the +5V supply to the Pi. Battery
voltage levels are measured using the built-in microcontroller analog
to digital converter and compared to predefined discharging profile
(default or programmed via I</SPAN><SUP><SPAN LANG="en-US">2</SPAN></SUP><SPAN LANG="en-US">C
commands). Each profile define four voltage levels: battery full,
battery good, battery low, battery critical) A RGB LED </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">D7</SPAN></FONT></FONT><SPAN LANG="en-US">
lights on blue, green or red to indicate the actual voltage level.
Its state is also accessible via I</SPAN><SUP><SPAN LANG="en-US">2</SPAN></SUP><SPAN LANG="en-US">C
status command. During operation, the microcontroller continuously
monitors the voltage level, and when it falls beneath a low battery
level that it believes leaves only a few minutes of operational time,
it switches the RGB LED to red. Simultaneously the green LED of the
low battery starts flashing, indicating that the pack needs
replacement. If the user connects to MoPi-2 another, fresh battery
pack, the work continues. Another possibility is the user to force
clean shutdown pressing and holding the power switch </SPAN><FONT FACE="Courier New, monospace"><FONT SIZE=3><SPAN LANG="en-US">SW1</SPAN></FONT></FONT><SPAN LANG="en-US">
for 3 seconds. If nothing changes and the battery continues to
discharge down to a critical level, then the RGB LED starts flashing
red and MoPi-2 forces clean shutdown. </SPAN>
</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm"><SPAN LANG="en-US"><B>Notes:</B></SPAN><SPAN LANG="en-US">
</SPAN>
</P>
<UL>
	<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm">The MoPi-2
	default discharging profile is for 8 NiMH rechargeable batteries
	with the following voltage levels: 
	</P>
	<UL>
		<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm">Battery Full
			11.2V</P>
		<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm">Battery Good 	 
		9.8V</P>
		<LI><P CLASS="western" STYLE="margin-bottom: 0.1cm">Battery Low	 
		9.35V</P>
		<LI><P CLASS="western">Battery Crytical	  8.5V	   
		</P>
	</UL>
	<LI><P CLASS="western">User alerts and clean shutdown are combined
	functions of MoPi-2 and installed in a Pi Simbamon daemon. 
	</P>
</UL>
<H2 CLASS="western"><A NAME="__RefHeading__5542_902516158"></A>3.2.Load
Signal 
</H2>
<P CLASS="western">MoPi-2  continuously monitors the magnitude of the
load current (current to the Pi). If it becomes near 2.5A, the red
LED D11 starts flashing. The LED goes off when the magnitude drops
down to 2.0A or less. 
</P>
<H2 CLASS="western"><A NAME="__RefHeading__5544_902516158"></A>3.3.Charger
Gate 
</H2>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">One of the MoPi
improvements is the ability to charge the batteries without
disconnect them. To <SPAN LANG="en-US">implement</SPAN> this feature
MoPi-2 has additional gate, connector <FONT FACE="Courier New, monospace"><FONT SIZE=3>X1</FONT></FONT>,
where an external charger can be connect. The battery pack has to be
connected to <FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#2</FONT></FONT>
input. The other input, <FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#1</FONT></FONT>,
can be use for another power source, e.g. wall adapter. MoPi-2 will
use the <FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#1</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
input</FONT></FONT> while its voltage magnitude is higher than the
<FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#2</FONT></FONT>
magnitude. The charger gate will open if 
</P>
<OL>
	<P CLASS="western" STYLE="margin-bottom: 0.2cm">1)  there is a
	charger connect to it,</P>
	<P CLASS="western" STYLE="margin-bottom: 0.2cm"> 2)  there is a
	battery connected to <FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
	</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#2</FONT></FONT>
	input, and 
	</P>
	<P CLASS="western" STYLE="margin-bottom: 0.2cm">3)  <FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
	</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#1</FONT></FONT>
	voltage is higher than <FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
	</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#2</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
	voltage. </FONT></FONT>
	</P>
</OL>
<P CLASS="western" STYLE="margin-bottom: 0.2cm"><FONT FACE="Arial, sans-serif"><FONT SIZE=3>All
charging parameters, such as magnitude of the current, duration of
the charge, termination etc depends entirely on the functionality of
the external charger. Mopi-2 will terminate charging and close the
charger gate only if </FONT></FONT>
</P>
<OL START=0>
	<P CLASS="western" STYLE="margin-bottom: 0.2cm"><FONT FACE="Arial, sans-serif"><FONT SIZE=3>1)
	 the charger or the battery are disconnected, </FONT></FONT>
	</P>
	<P CLASS="western" STYLE="margin-bottom: 0.2cm"><FONT FACE="Arial, sans-serif"><FONT SIZE=3>2)
	 the </FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
	</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#1</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
	voltage becomes equal to or less than </FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>BATTERY</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
	</FONT></FONT><FONT FACE="Courier New, monospace"><FONT SIZE=3>#2</FONT></FONT><FONT FACE="Arial, sans-serif"><FONT SIZE=3>
	voltage, or  </FONT></FONT>
	</P>
	<P CLASS="western" STYLE="margin-bottom: 0.2cm"><FONT FACE="Arial, sans-serif"><FONT SIZE=3>3)
	 MoPi-2 shuts down. </FONT></FONT>
	</P>
</OL>
<P CLASS="western">When the charger gate is open, the green LED <FONT FACE="Courier New, monospace"><FONT SIZE=3>D10</FONT></FONT>
lights on. 
</P>
<H2 CLASS="western"><A NAME="__RefHeading__5546_902516158"></A>3.4.Microcontroller
</H2>
<P CLASS="western">The microcontroller (with embedded firmware)
implements all the functions related to voltage level monitoring,
level signaling (via the LEDs and the I<SUP>2</SUP>C interface),
on/off switching of the +5V supply to the Pi, and charger gate
on/off. An 8-bit low-power EFM8BB1 by Silicon Labs is used. 
</P>
<H2 CLASS="western"><A NAME="__RefHeading__5548_902516158"></A>3.5.MoPi-2
Modes 
</H2>
<P CLASS="western">MoPi-2 has the following modes of operation: 
</P>
<UL>
	<LI><P CLASS="western"><B>Normal Mode</B><SPAN STYLE="font-weight: normal">
	&ndash; MoPi-2 is started and supplies +5V to the Pi. The power
	consumption is 15mA. </SPAN>
	</P>
	<LI><P CLASS="western"><B>Sleep Mode</B><SPAN STYLE="font-weight: normal">
	&ndash; MoPi-2 enters this mode when an Power Up Delay I</SPAN><SUP><SPAN STYLE="font-weight: normal">2</SPAN></SUP><SPAN STYLE="font-weight: normal">C
	command has been issued before Shutdown command. The +5V to the Pi
	are switched off, the LEDs also. Only the microcontroller is
	counting the preset delay. When end of the count is reached, MoPi-2
	wakes up switching to Normal Mode. The power consumption in Sleep
	Mode is 0.5mA. </SPAN>
	</P>
</UL>
<UL>
	<LI><P CLASS="western"><B>Off Mode</B><SPAN STYLE="font-weight: normal">
	&ndash; MoPi-2 initial state or result of an Shutdown command. Most
	of the components, including the microcontroller are disconnected
	and MoPi-2 takes 15</SPAN><FONT FACE="Arial, sans-serif"><SPAN STYLE="font-weight: normal">&micro;</SPAN></FONT><SPAN STYLE="font-weight: normal">A
	</SPAN><SPAN STYLE="font-weight: normal">only! To switch on and go
	to Normal Mode the power switch has to be pressed for 2 seconds. </SPAN>
	</P>
	<LI><P CLASS="western"><B>Idle Mode</B><SPAN STYLE="font-weight: normal">
	&ndash; </SPAN><SPAN LANG="en-US"><SPAN STYLE="font-weight: normal">If
	MoPi-2 is running without load (probably the Pi  is powered up via
	its micro-USB connector or the PCB is not inserted on the GPIO
	pins), the firmware switches the device in Idle Mode. The voltage
	regulator is on generating +5V, but they are split from the Pi by
	the &ldquo;smart diode&rdquo; </SPAN></SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US"><SPAN STYLE="font-weight: normal">T10</SPAN></SPAN></FONT><SPAN LANG="en-US"><SPAN STYLE="font-weight: normal">.
	The status LED flashes slow in </SPAN></SPAN><SPAN LANG="en-US"><SPAN STYLE="font-weight: normal">blue
	or green in dependence of the input voltage level. Once a load is
	applied, e.g. the Pi's 5V goes off and </SPAN></SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US"><SPAN STYLE="font-weight: normal">T10</SPAN></SPAN></FONT><SPAN LANG="en-US"><SPAN STYLE="font-weight: normal">
	opens up to power the Pi, MoPi-2 switches to Normal Mode keeping the
	Pi to run smooth. The status LED lights steady after the switching. </SPAN></SPAN>
	</P>
</UL>
<H1 CLASS="western"><A NAME="__RefHeading__5550_902516158"></A><A NAME="4.The MoPi-2 Software Suite |outline"></A><A NAME="4.The MoPi-2 Software Suite |outline"></A>
4.The MoPi-2 Software Suite 
</H1>
<P CLASS="western">This section describes how the MoPi-2 software
suite works and how the architecture of MoPi-2 hangs together.</P>
<P CLASS="western">There are four main parts of the puzzle:</P>
<UL>
	<LI><P CLASS="western">A <I>daemon</I> which runs in the background
	on the Pi, which is called <A HREF="#3.1.simbamond, the simbamon daemon|outline">simbamond</A>
	(simbamon daemon, or SImple BAttery MONnitor daemon). It is
	available as a package for Raspbian, and installing it pulls in all
	MoPi-2 software. 
	</P>
	<LI><P CLASS="western">An interface that communicates with the
	MoPi-2 hardware over the I2C protocol. This interface is wrapped up
	as a <A HREF="#3.2.The Python API |outline">Python API</A>.</P>
	<LI><P CLASS="western">A <A HREF="#4.3.MoPi-2 from the Command Line |outline">command-line
	tool</A> that uses the Python API and provides a language-neutral
	portable method for talking to the board from the Pi.</P>
	<LI><P CLASS="western">A <A HREF="#2.3.2.Using the Configuration Tool on the Pi |outline">configuration
	user interface</A> that simplifies the process of setting up MoPi-2
	to deal with different types and numbers of batteries, and other
	types of power supply. 
	</P>
</UL>
<P CLASS="western">All of the code for these components is <A HREF="https://github.com/hamishcunningham/pi-tronics/tree/master/simbamon">available
on GitHub</A>. 
</P>
<P CLASS="western">The rest of this section discusses each of the
main elements in turn, describes how to check up on the beast as it
runs, and finishes up with more detail of the implementation of the
daemon. 
</P>
<H2 CLASS="western"><A NAME="__RefHeading__5552_902516158"></A>4.1.simbamond,
the simbamon daemon 
</H2>
<P CLASS="western">When the Pi (or any other Linux system) boots,
several system services are started that will run continuously until
the machine is shut down again. These services are called daemons, of
which simbamon is one. The first point of entry, used by the
operating system to start, stop, etc., is an init (think
initialisation) script: <A HREF="https://github.com/hamishcunningham/pi-tronics/blob/master/simbamon/simbamond.default"><FONT FACE="Courier New, monospace">/etc/init.d/simbamond</FONT></A>.
This script (which you can think of as a wrapper for management)
calls another script to do the real work: <A HREF="https://github.com/hamishcunningham/pi-tronics/blob/master/simbamon/simbamon"><FONT FACE="Courier New, monospace">/usr/sbin/simbamon</FONT></A>.
</P>
<P CLASS="western">One of key features of MoPi-2 is that it supports
many different types of batteries and many other types of power
supply (from solar panels to elastic bands!). Coping with the
requirements of all these monsters needs a huge wodge of
configuration data, which (following Debian Linux convention) lives
in <FONT FACE="Courier New, monospace">/etc/default/</FONT> in a file
(again, confusingly) called <A HREF="https://github.com/hamishcunningham/pi-tronics/blob/master/simbamon/simbamond.init">simbamond</A>.<A HREF="#Footnote5"><SUP>5</SUP></A></P>
<P CLASS="western">Together these three script files make up a new
system service that polls the MoPi-2 hardware every couple of seconds
and shouts loudly when an electron shortage appears on the horizon.
If no one is listening and the shortage gets acute, the daemon tells
the Pi to take a rest and issues the <FONT FACE="Courier New, monospace">shutdown</FONT>
command.</P>
<P CLASS="western">There is <A HREF="#4.6.simbamon: a simple battery monitor |outline">more
detail below</A>. 
</P>
<H2 CLASS="western"><A NAME="__RefHeading__5554_902516158"></A><A NAME="3.2.The Python API |outline"></A><A NAME="4.2.The Python API |outline"></A>
4.2.The Python API 
</H2>
<P CLASS="western">How do we talk to the hardware? From MoPi-2
version 3 onwards we shifted away from using the Pi's general-purpose
GPIO pins (using a tool called WiringPi). This worked well, but it
used a pin for each bit of data that we wanted to ship between the
board and the Pi. As time went on we found more and more data that we
needed to share (and we also came across other add-on boards that use
lots of GPIO pins &mdash; e.g. <A HREF="http://pi.gate.ac.uk/posts/2014/02/07/airpi1/">AirPi</A>).</P>
<P CLASS="western">Luckily the Pi also hosts several other
inter-board communication options, including the I2C protocol, which
uses only two pins, can talk to multiple devices over the same two
wires, and allows transfer of much larger amounts of data. 
</P>
<P CLASS="western">There are two ways to talk over I2C from the Pi: a
set of command-line tools written in C, and a Python module. Both
work, but the Python version seems to have had more attention from Pi
users and developers, and even has support for multi-byte reads. So
we've implemented an API for MoPi-2 in Python<A HREF="#Footnote6"><SUP>6</SUP></A>,
which now lives in a file called <FONT FACE="Courier New, monospace">mopiapi.py</FONT>.
For Python programmers this code provides a natural and efficient
method of including MoPi-2 facilities in their programs. For example,
writing a system tray applet...</P>
<H2 CLASS="western"><A NAME="__RefHeading__5556_902516158"></A><A NAME="3.3.MoPi-2 from the Command Line |outline"></A><A NAME="3.3.MoPi-2 from the Command Line |outline"></A><A NAME="4.3.MoPi-2 from the Command Line |outline"></A><A NAME="4.3.MoPi-2 from the Command Line |outline"></A>
4.3.MoPi-2 from the Command Line 
</H2>
<P CLASS="western">The observant amongst you may have noticed that
simbamon is not written in Python<A HREF="#Footnote7"><SUP>7</SUP></A>
&mdash; how does the daemon talk to the board when the API is in
Python? That's where <A HREF="https://github.com/hamishcunningham/pi-tronics/blob/master/simbamon/mopicli"><FONT FACE="Courier New, monospace">mopcli</FONT></A>
comes in, which is a command-line interface to the Python API. This
script provides convenient methods for the daemon to use, or for Pi
users to query and configure the board, or for our configuration
utility &mdash; which by amazing coincidence is described next.</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">To see what the beast
can do, ask it for help by typing <FONT FACE="Courier New, monospace">sudo</FONT><FONT FACE="Arial, sans-serif">
</FONT><FONT FACE="Courier New, monospace">mopicli</FONT><FONT FACE="Arial, sans-serif">
</FONT><FONT FACE="Courier New, monospace">-h</FONT>; you'll get
something like this:</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Usage:
mopicli [-h] [options]</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">This
tool is for interfacing with the MoPi-2 battery power add-on board
for the Raspberry Pi. (http://pi.gate.ac.uk)</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Package
Version 4.0</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Version
0.5, API 0.3</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Miscellaneous:</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-i
x  I2C bus</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Where
x is the I2C bus that connects the MoPi-2 to the Raspberry Pi. If
this flag is not set, the default bus of 1 is used, based on board
revision.</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-fv
  Firmware version</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-sn
  Serial number</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-h
   Display this message</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-e
   Read everything possible from the MoPi-2</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-nl
  No labels on output</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Status:</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-s
   MoPi-2 status word</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-sv
  Verbose status</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-v
   Current source voltage in mV</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-v1
  Source #1 voltage in mV</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-v2
  Source #2 voltage in mV</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Read
configuration options:</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-rc
  Combined source #1/#2 conf</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-rc1
 Source #1 conf</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-rc2
 Source #2 conf</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-ron
 Power on delay</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-rsd
 Shutdown delay</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Write
configuration options:</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-wc
t mV mV mV mV     Combined source #1/#2 conf</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-wc1
t mV mV mV mV    Source #1 conf</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-wc2
t mV mV mV mV    Source #2 conf</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">Where
t (type) is 1 for rechargeable batteries, 2 for non-rechargeable</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">batteries,
3 for PSU / DC adapter, and the four mV settings are the</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">mmaximum,
good, low, and critical voltage levels.</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-won
seconds          Power on timer in seconds</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">This
timer counts down from the moment the MoPi-2 is powered off and turns
it back on when reaching zero.</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">-wsd
seconds          Shutdown timer in seconds</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">This
timer counts down from the moment it is set and powers off the MoPi-2
when reaching zero.</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">All
options may be used simultaneously. When doing so, they execute in
the</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.2cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">order
they are listed in in this help message. However, only one of each
may be used. </FONT></FONT>
</P>
<P CLASS="western">As easy as pie. 
</P>
<H2 CLASS="western"><A NAME="__RefHeading__5558_902516158"></A><A NAME="4.4.Configuring Your Power Supplies |outline"></A><A NAME="4.4.Configuring Your Power Supplies |outline"></A><A NAME="4.4.Configuring Your Power Supplies |outline"></A>
4.4.Configuring Your Power Supplies 
</H2>
<P CLASS="western">Not quite so easy is choosing the correct voltage
settings for different battery chemistries and different combinations
of cells (not to mention other types of power supply). In each case
MoPi-2 needs to know:</P>
<UL>
	<LI><P CLASS="western">What is the approximate voltage that the
	battery will supply when fully charged? 
	</P>
	<LI><P CLASS="western">What is the point at which we're getting low
	on charge? (And therefore may expect to run out of juice within a
	few minutes or so.) 
	</P>
	<LI><P CLASS="western">what is the minimum safe discharge voltage?
	(Just above the critical deep discharge level of the batteries.) 
	</P>
</UL>
<P CLASS="western">The mid-point between the first two voltages is is
the conventional definition of what a good level of charge is, so
that's where we swap between lighting up our RGB led in blue and
lighting it in green. When we reach the low charge point we turn the
LED red, and when we reach the minimum safe discharge voltage (or the
minimum safe operating voltage of our micro-controller at 6.5V if
that is higher) then we initiate shutdown.</P>
<P CLASS="western">Let's look at each of these values in more detail:</P>
<UL>
	<LI><P CLASS="western"><I>Fully-charged voltage</I>. This is equal
	to the fully-charged voltage of each cell in the battery pack
	multiplied by the number of cells. Like most things with batteries,
	it varies according to battery chemistry &mdash; e.g. an Alkaline
	cell generates 1.5V; a NiMH 1.2V; a LiIon 3.7V. 
	</P>
	<LI><P CLASS="western"><I>The low charge level</I>. When you record
	the voltage delivered by a battery over time, most of the curves
	exhibit a knee shape. Before the knee voltage drop is reasonably
	slow; after the knee if drops much more sharply. We need to try and
	warn the user around the knee point, so that they have enough time
	to replace the battery before it drains completely, but not so much
	time that there is still lots of usable charge left. 
	</P>
	<LI><P CLASS="western"><I>Minimum safe discharge voltage</I>. This
	applies to all rechargeable batteries. If we discharge below this
	level, then the capacity to recharge will be impared. This makes it
	a very important factor in battery life for the long term, and one
	which we've done a lot of work to model and adapt to. (Ever wondered
	why the rechargeables that you put in your alarm clock or torch
	lasted such a short time? Most devices have no way of knowing about
	the minimum discharge level for the particular chemistry you're
	using!) 
	</P>
	<LI><P CLASS="western"><I>Minimum safe operating level</I>. MoPi-2
	uses a sophisticated microcontroller to analyse battery behaviour,
	control its LEDs and deliver data to the software suite running on
	the Pi. If the supply voltage to MoPi-2 falls below a certain level
	(around 6.5V) then the microcontroller may terminate, or even start
	to behave unpredictably. It is very important to trap rapid voltage
	drop before it reaches this point. 
	</P>
</UL>
<P CLASS="western">To deal with all these considerations, the current
version of the software stores these values: 
</P>
<DL>
	<DL>
		<DL>
			<DD>
			<TABLE WIDTH=418 BORDER=0 CELLPADDING=4 CELLSPACING=0>
				<COL WIDTH=36>
				<COL WIDTH=153>
				<COL WIDTH=107>
				<COL WIDTH=90>
				<TR VALIGN=TOP>
					<TD WIDTH=36>
						<P CLASS="western" ALIGN=CENTER><BR>
						</P>
					</TD>
					<TD WIDTH=153>
						<P CLASS="western" ALIGN=LEFT><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt"><B>TYPE</B></FONT></FONT></P>
					</TD>
					<TD WIDTH=107>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt"><B>CELL/FULL</B></FONT></FONT></P>
					</TD>
					<TD WIDTH=90>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt"><B>MIN</B></FONT></FONT></P>
					</TD>
				</TR>
				<TR VALIGN=TOP>
					<TD WIDTH=36>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">1</FONT></FONT></P>
					</TD>
					<TD WIDTH=153>
						<P CLASS="western"><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">non-battery</FONT></FONT></P>
					</TD>
					<TD WIDTH=107>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">9.0</FONT></FONT></P>
					</TD>
					<TD WIDTH=90>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">6.2</FONT></FONT></P>
					</TD>
				</TR>
				<TR VALIGN=TOP>
					<TD WIDTH=36>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">2</FONT></FONT></P>
					</TD>
					<TD WIDTH=153>
						<P CLASS="western"><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">NiMH</FONT></FONT></P>
					</TD>
					<TD WIDTH=107>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">1.2</FONT></FONT></P>
					</TD>
					<TD WIDTH=90>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">0.95</FONT></FONT></P>
					</TD>
				</TR>
				<TR VALIGN=TOP>
					<TD WIDTH=36>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">3</FONT></FONT></P>
					</TD>
					<TD WIDTH=153>
						<P CLASS="western"><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">Alkaline</FONT></FONT></P>
					</TD>
					<TD WIDTH=107>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">1.5</FONT></FONT></P>
					</TD>
					<TD WIDTH=90>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">0.8</FONT></FONT></P>
					</TD>
				</TR>
				<TR VALIGN=TOP>
					<TD WIDTH=36>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">4</FONT></FONT></P>
					</TD>
					<TD WIDTH=153>
						<P CLASS="western"><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">Lead
						Acid</FONT></FONT></P>
					</TD>
					<TD WIDTH=107>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">2.0</FONT></FONT></P>
					</TD>
					<TD WIDTH=90>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">1.58</FONT></FONT></P>
					</TD>
				</TR>
				<TR VALIGN=TOP>
					<TD WIDTH=36>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">5</FONT></FONT></P>
					</TD>
					<TD WIDTH=153>
						<P CLASS="western"><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">Lithium
						Ion</FONT></FONT></P>
					</TD>
					<TD WIDTH=107>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">3.7</FONT></FONT></P>
					</TD>
					<TD WIDTH=90>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">3.0</FONT></FONT></P>
					</TD>
				</TR>
				<TR VALIGN=TOP>
					<TD WIDTH=36>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">6</FONT></FONT></P>
					</TD>
					<TD WIDTH=153>
						<P CLASS="western"><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">LiPo</FONT></FONT></P>
					</TD>
					<TD WIDTH=107>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">4.2</FONT></FONT></P>
					</TD>
					<TD WIDTH=90>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">3.0</FONT></FONT></P>
					</TD>
				</TR>
				<TR VALIGN=TOP>
					<TD WIDTH=36>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">7</FONT></FONT></P>
					</TD>
					<TD WIDTH=153>
						<P CLASS="western"><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">NiCd</FONT></FONT></P>
					</TD>
					<TD WIDTH=107>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">1.2</FONT></FONT></P>
					</TD>
					<TD WIDTH=90>
						<P CLASS="western" ALIGN=CENTER><FONT FACE="Arial, sans-serif"><FONT SIZE=2 STYLE="font-size: 11pt">1.1</FONT></FONT></P>
					</TD>
				</TR>
			</TABLE>
		</DL>
	</DL>
</DL>
<P CLASS="western">When we know what chemistry we're dealing with,
and how many cells, we can then make good guesses about where the
four levels above should fall. But how do we know what the chemistry
is? Two ways:</P>
<UL>
	<LI><P CLASS="western">We have <A HREF="#2.3.1.Choosing Default Supply Profile |outline">built-in
	default</A> &ndash; 8 NiMH cells 
	</P>
	<LI><P CLASS="western">You tell us! To this end we have developed a
	configuration UI on the Pi, which is the last piece in our four part
	software puzzle. 
	</P>
</UL>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">The configuration UI
uses the same tools as the Raspberry Pi's utility (<FONT FACE="Courier New, monospace">raspi-config</FONT>),
so it should be simple and familiar, and it can be used over all
types of connections (including remote login with <FONT FACE="Courier New, monospace">ssh</FONT>).
Here's a screen shot or three: 
</P>
<P CLASS="western" STYLE="line-height: 100%"><IMG SRC="images/config-01.png" NAME="графики2" ALIGN=LEFT VSPACE=4 WIDTH=643 HEIGHT=432 BORDER=0><BR CLEAR=LEFT><I>The
main entry screen.</I></P>
<P CLASS="western"><IMG SRC="images/config-02.png" NAME="графики3" ALIGN=LEFT VSPACE=4 WIDTH=643 HEIGHT=427 BORDER=0><BR CLEAR=LEFT><I>Configuring
one of the power supplies, battery chemistry. </I>
</P>
<P CLASS="western"><IMG SRC="images/config-03.png" NAME="графики4" ALIGN=LEFT VSPACE=4 WIDTH=643 HEIGHT=429 BORDER=0><BR CLEAR=LEFT><I>Getting
status data (there's lots more in the newest version!) </I>
</P>
<P CLASS="western">Dive into <A HREF="https://github.com/hamishcunningham/pi-tronics/blob/master/simbamon/mopi">the
source code here</A>.</P>
<P CLASS="western">And now you know more about batteries than you
ever wanted to &mdash; just like me!</P>
<H2 CLASS="western"><A NAME="__RefHeading__5560_902516158"></A>4.5.Monitoring
</H2>
<P CLASS="western">As you can imagine, figuring out how all this
stuff is working and identifying bugs and incorrect behaviour is
quite a challenge. Luckily we have some great tools to help us, one
of which is <A HREF="https://mmonit.com/">Monit</A>. This little gem
is itself a daemon, and it has facilities for one thousand and one
different types of monitoring task. You can listen to your webserver
and restart it if it fails, or check the general load of the machine
you're running on, or &mdash; in our case &mdash; check that the
simbamon service is running, and if not start it up.</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">To use it, all we
need to do is <FONT FACE="Courier New, monospace">sudo</FONT><FONT FACE="Arial, sans-serif">
</FONT><FONT FACE="Courier New, monospace">apt-get</FONT><FONT FACE="Arial, sans-serif">
</FONT><FONT FACE="Courier New, monospace">install</FONT><FONT FACE="Arial, sans-serif">
</FONT><FONT FACE="Courier New, monospace">monit</FONT> in the usual
way, then edit <FONT FACE="Courier New, monospace">/etc/monit/monitrc</FONT>.
This is the config we're using to monitor simbamon on one of our test
rigs:</P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2>########<FONT SIZE=2 STYLE="font-size: 11pt">#######################################################################</FONT></FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
monit config for simbamond, from /etc/monit/monitrc </FONT></FONT>
</P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#########################</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
monitoring UI (serve on port 8888 and allow connections from one IP
address)</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">set
httpd port 8888 and</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">allow
192.168.1.111</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
general system status</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">check
system mopi-15</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
loadavg (1min) &gt; 4 then alert</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
loadavg (5min) &gt; 2 then alert</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
memory usage &gt; 75% then alert</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
swap usage &gt; 25% then alert</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
cpu usage (user) &gt; 70% then alert</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
cpu usage (system) &gt; 30% then alert</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
cpu usage (wait) &gt; 20% then alert</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
monitor simbamond</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">check
process simbamond with pidfile /var/run/simbamond.pid</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">start
program = &quot;/usr/sbin/service simbamond start&quot; with timeout
60 seconds</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">stop
program  = &quot;/usr/sbin/service simbamond stop&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">restart
program = &quot;/usr/sbin/service simbamond restart&quot; with
timeout 60 seconds</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
cpu &gt; 60% for 2 cycles then alert</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
cpu &gt; 80% for 5 cycles then restart</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
totalmem &gt; 200.0 MB for 5 cycles then restart</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
children &gt; 250 then restart</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
loadavg(5min) greater than 10 for 8 cycles then stop</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
3 restarts within 5 cycles then timeout</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"> 
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">group
mopi</FONT></FONT></P>
<P CLASS="western" STYLE="line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2>###############################################################################</FONT></FONT></P>
<P CLASS="western">You can then see what's going on by either or both
of</P>
<UL>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">cat/var/log/monit.log</SPAN></FONT><SPAN LANG="en-US">
	(</SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">|</SPAN></FONT><FONT FACE="Arial, sans-serif"><SPAN LANG="en-US">
	</SPAN></FONT><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">grep</SPAN></FONT><FONT FACE="Arial, sans-serif"><SPAN LANG="en-US">
	</SPAN></FONT><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">simbamon</SPAN></FONT><SPAN LANG="en-US">
	is also useful) </SPAN>
	</P>
	<LI><P CLASS="western"><SPAN LANG="en-US">pointing your browser at
	</SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">http://my-pi-ip-address:8888</SPAN></FONT><SPAN LANG="en-US">
	(if you need to find your IP address various methods are </SPAN><A HREF="https://pi.gate.ac.uk/pages/blinkip.html">discussed
	here</A><SPAN LANG="en-US">) </SPAN>
	</P>
</UL>
<P CLASS="western">This is great for keeping check on things during
load testing (particularly heavy loads which have a tendency to cause
odd corner case bugs to trigger), but it is also a great tool for
maximizing service availability &mdash; the configuration code above
will restart simbamon within a couple of minutes should it ever
crash, for example.</P>
<H2 CLASS="western"><A NAME="__RefHeading__5562_902516158"></A><A NAME="4.6.simbamon: a simple battery monitor |outline"></A><A NAME="4.6.simbamon: a simple battery monitor |outline"></A>
4.6.simbamon: a simple battery monitor 
</H2>
<H3 CLASS="western"><A NAME="__RefHeading__5564_902516158"></A>4.6.1.Design
Notes 
</H3>
<P CLASS="western">There are a variety of ways that laptops
communicate with and control their batteries, including the <A HREF="http://batteryuniversity.com/learn/article/inner_workings_of_a_smart_battery">Smart
Battery specification</A> (which often uses SMBus, a variant of the
I2C interface that the Pi supports). In Linux the resultant data feed
is then modelled using a power management abstraction (of which ACPI
is the most recent) and manipulated using a driver specific to the
battery in use.</P>
<P CLASS="western">Sounds like a good idea? Yes, in the abstract, but
implementing a new driver is quite a job &mdash; <A HREF="https://github.com/torvalds/linux/blob/master/drivers/acpi/battery.c">here's
one</A> that runs to 1200 lines of C code, for example. It is also
not clear how to do this when we have the ability to plug in
batteries of different types, which is something we really wanted to
support.</P>
<P CLASS="western">What to do? 
</P>
<P CLASS="western">If in doubt, take the simple option. All Linux
systems share the system service or daemon concept. A system-level
process which gets run during startup. It is quite easy to implement
a battery monitor daemon that listens on the Pi's I2C bus for level
changes signaled by the MoPi-2 microcontroller board. The daemon then
makes entries in the standard system logs as a simple way to share
data with other subsystems, and can be configured to send a warning
message to all users if levels are low. Best of all, the daemon can
easily shut down the Pi cleanly before the regulator voltage gets too
low for reliable operation. 
</P>
<H3 CLASS="western"><A NAME="__RefHeading__5566_902516158"></A>4.6.2.Implementation
</H3>
<P CLASS="western">This section gives more detail of the
implementation of the simbamon battery monitoring daemon. It is
designed for the MoPi-2 boards, but should be quite easily reusable
for other battery power projects. simbamon is an open source Linux
daemon for:</P>
<UL>
	<LI><P CLASS="western">Monitoring battery levels (for us this is
	done via the <A HREF="#3.3.MoPi-2 from the Command Line |outline"><FONT FACE="Courier New, monospace">mopicli</FONT></A>
	command)</P>
	<LI><P CLASS="western">Sending warning messages to the user if the
	battery is low</P>
	<LI><P CLASS="western">Shutting down cleanly at critical battery
	levels</P>
	<LI><P CLASS="western">Managing a power supply on/off switch</P>
	<LI><P CLASS="western">Writing relevant data to the system logs. 
	</P>
</UL>
<P CLASS="western">You can find <A HREF="https://github.com/hamishcunningham/pi-tronics/tree/master/simbamon">the
source code</A> on GitHub. The core of the daemon is defined in three
files:</P>
<UL>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">/etc/init.d/simbamond</SPAN></FONT><SPAN LANG="en-US">
	&mdash; an interface to the init subsystem that Linux uses to manage
	daemons (amongst other things) </SPAN>
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">/usr/sbin/simbamon</SPAN></FONT><SPAN LANG="en-US">
	&mdash; the daemon itself </SPAN>
	</P>
	<LI><P CLASS="western"><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">/etc/default/simbamond</SPAN></FONT><SPAN LANG="en-US">
	&mdash; configuration data </SPAN>
	</P>
</UL>
<P CLASS="western"><SPAN LANG="en-US">The first of these, </SPAN><FONT FACE="Courier New, monospace"><SPAN LANG="en-US">simbamond</SPAN></FONT><SPAN LANG="en-US">,
is used by the operating system to start and stop simbamon at boot or
shutdown time, and can be used to control simbamon manually when
required. For example this command will stop the daemon:</SPAN></P>
<P CLASS="western" STYLE="margin-left: 1.27cm"><FONT FACE="Courier New, monospace">sudo<FONT FACE="Arial, sans-serif">
</FONT>service<FONT FACE="Arial, sans-serif"> </FONT>simbamond<FONT FACE="Arial, sans-serif">
</FONT>stop</FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">The configuration
file, (also) <FONT FACE="Courier New, monospace">simbamond</FONT>,
defines how simbamon will take action. Of primary interest is the
last few lines, which specifies the battery configuration in <A HREF="#3.3.MoPi-2 from the Command Line |outline">CLI</A>
format. There's some generic stuff at the top too about monitoring
frequency and stuff, it's pretty well explained in the file.</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">###################################################################</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
local config - DON'T EDIT THIS LINE!</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
-wc 1 11200 10000 8800 8000</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
end of local config - DON'T EDIT THIS LINE EITHER!</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%"><FONT FACE="Arial, sans-serif"><FONT SIZE=3>The
MoPi-2 microcontroller supplies these states via the Raspberry Pi's
<A HREF="http://en.wikipedia.org/wiki/I&sup2;C">I</A><A HREF="http://en.wikipedia.org/wiki/I&sup2;C"><SUP>2</SUP></A><A HREF="http://en.wikipedia.org/wiki/I&sup2;C">C
bus</A> (and also sets on-board indicator LEDs accordingly). The core
of simbamon, a shell script that lives in <FONT FACE="Courier New, monospace">/usr/sbin/simbamon</FONT>,
implements an infinite loop that checks the levels being reported
every few seconds and takes any necessary action. The <FONT FACE="Courier New, monospace">wall</FONT>
command is used to send messages to any user currently logged in.</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%"><FONT FACE="Arial, sans-serif"><FONT SIZE=3>Here's
a condensed version of the main loop (error checking, debug logging
and other details omitted):</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">while
:</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">do</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
loop indices</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">i=$((
${i} + 1 )); j=$(( ${j} + 1 ))</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<BR><BR>
</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
get MoPi-2 status</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">MOPI_STATUS=&quot;`mopicli
-nl -s`&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<BR><BR>
</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
action states (shutdown or warn)</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
s_forced_shutdown &quot;$MOPI_STATUS&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">then</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">wall
&lt;&lt;&lt; &quot;${NAME}: power off requested: shutting down
now!!!&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">logger
&quot;${NAME}: shutting down (POWER_OFF; ${MOPI_STATUS})&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">eval
&quot;$SHUTDOWN&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">elif
s_bat_critical &quot;$MOPI_STATUS&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">then</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">wall
&lt;&lt;&lt; &quot;${NAME}: battery empty: shutting down now!!!&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">logger
&quot;${NAME}: shutting down (BAT_SHUTDOWN; ${MOPI_STATUS})&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">eval
&quot;$SHUTDOWN&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">elif
s_bat_low &quot;$MOPI_STATUS&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">then</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">if
[ $PREV_WARNING -eq 0 -o $(( $i - $PREV_WARNING )) -ge $WAIT_LOOPS ]</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">then</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
      <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">PREV_WARNING=$i</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
      <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">wall
&lt;&lt;&lt; &quot;${NAME}: ${LMESS} is low! connect new battery or
shut down&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
      <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">logger
&quot;${NAME}: BAT_WARNING (${MOPI_STATUS})&quot;</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">fi</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">fi</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<BR><BR>
</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
routine log messages</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">[
&quot;$DEBUG&quot; = on -o ${j} -eq ${LOG_INTERVAL} ] &amp;&amp; \</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
    <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">logger
&quot;${NAME}: ${LMESS} is ${MOPI_STATUS} at `pdate` (i=${i})&quot;
&amp;&amp; j=0</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<BR><BR>
</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">#
take a break</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
  <FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">sleep
${MONITOR_FREQUENCY}</FONT></FONT></P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.1cm; line-height: 100%">
<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">done
&amp;</FONT></FONT></P>
<P CLASS="western">Here is the <A HREF="https://github.com/hamishcunningham/pi-tronics/blob/master/simbamon/simbamon">current
version of the code</A>.</P>
<H3 CLASS="western"><A NAME="__RefHeading__5568_902516158"></A>4.6.3.Installig
Simbamon 
</H3>
<P CLASS="western" STYLE="margin-bottom: 0.2cm">The <A HREF="http://www.raspberrypi.org/archives/tag/alex-bradbury">Raspbian
maintainers</A> have been kind enough to include simbamon in their
repository, so you can just do this (as <A HREF="#2.2.1.Quick Start |outline">noted
above</A>):</P>
<P CLASS="western" STYLE="margin-left: 1.27cm; margin-bottom: 0.2cm"><FONT FACE="Courier New, monospace">sudo<FONT FACE="Arial, sans-serif">
</FONT>apt-get<FONT FACE="Arial, sans-serif"> </FONT>install<FONT FACE="Arial, sans-serif">
</FONT>simbamond </FONT>
</P>
<P CLASS="western">Our software is also available from an <A HREF="https://launchpad.net/~hamish-dcs/+archive/pi-gate">Ubuntu
Personal Package Archive</A> (PPA). (The Ubuntu infrastructure
doesn't currently work for binary Pi packages, but simbamon and the
rest of the MoPi-2 suite is implemented in script (shell and Python),
so we're ok in this case.)<A HREF="#Footnote8"><SUP>8</SUP></A> To
install from this archive:</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%"><B>1</B>.
Add this line to <FONT FACE="Courier New, monospace">/etc/apt/</FONT><FONT FACE="Arial, sans-serif">
</FONT>sources.list:</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">	<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">deb
http://ppa.launchpad.net/hamish-dcs/pi-gate/ubuntu precise main</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">You
can use a text editor (e.g. nano) to do this, or paste this one-liner
into a terminal prompt:</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%">	<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">echo
deb http://ppa.launchpad.net/hamish-dcs/pi-gate/ubuntu precise </FONT></FONT>
</P>
<P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">	main
|sudo tee -a /etc/apt/sources.list</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm"><B>2</B>. Import the
<A HREF="http://www.gnupg.org/">GPG</A> encryption key from Ubuntu so
that the Pi can verify the package's validity:</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">	sudo
apt-key adv --recv-keys --keyserver keyserver.ubuntu.com </FONT></FONT>
</P>
<P CLASS="western"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">	--recv-key
6C12C1CF</FONT></FONT></P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%"><B>3</B>.
Update your list of available packages (this may take a couple of
minutes):</P>
<P CLASS="western" STYLE="line-height: 100%">	<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">sudo
apt-get update </FONT></FONT>
</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm; line-height: 100%"><B>4</B>.
Install the package:</P>
<P CLASS="western">  	<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">sudo
apt-get install simbamond</FONT></FONT></P>
<P CLASS="western">(You may ignore errors referring to module loading
here &mdash; see <A HREF="#faq-mkmod-error">above</A> for details.)</P>
<P CLASS="western">And that's it!</P>
<P CLASS="western" STYLE="margin-bottom: 0.2cm"><B>Note:</B> the
above gets you the most recent stable release; if you want to live on
the edge, you can get more recent experimental builds by adding the
snapshot PPA to your sources list, e.g.:</P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%">	<FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">echo
deb </FONT></FONT><A HREF="http://ppa.launchpad.net/hamish-dcs/pi-gate-snapshots/"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">http://ppa.launchpad.net/hamish-dcs/pi-gate-snapshots/</FONT></FONT></A></P>
<P CLASS="western" STYLE="margin-bottom: 0.1cm; line-height: 100%"><FONT FACE="Courier New, monospace"><FONT SIZE=2 STYLE="font-size: 11pt">	ubuntu
precise main |sudo tee -a /etc/apt/sources.list</FONT></FONT></P>
<P CLASS="western" STYLE="margin-top: 0.4cm; margin-bottom: 0.1cm"><FONT SIZE=4 STYLE="font-size: 16pt"><B>Footnotes</B></FONT></P>
<P CLASS="western"><A NAME="Footnote1"></A>1. We quote a 6.5V to 24V
max voltage to leave some headroom. We've run the board between 6.0V
and 25V but don't recommend it as a general rule. 
</P>
<P CLASS="western"><A NAME="Footnote2"></A><SPAN LANG="en-US">2.
Ignore </SPAN><A HREF="#faq-mkmod-error">errors related to </A><A HREF="#faq-mkmod-error"><SPAN LANG="en-US">kmod</SPAN></A><SPAN LANG="en-US">.
</SPAN>
</P>
<P CLASS="western"><A NAME="Footnote3"></A>3. Note that when MoPi-2
powers up the Pi, it then waits 60 seconds for the boot process to
finish. During this period power off requests will be ignored. 
</P>
<P CLASS="western"><A NAME="Footnote4"></A>4. Our Configuration Tool
is a command line user interface, similar to raspi-config.</P>
<P CLASS="western"><A NAME="Footnote5"></A>5. Confusingly the names
of the files as they live in the source package are different from
their names when installed. If you don't like being confused, you
might want to avoid talking to computer people as a general rule. For
example, the MoPi-2 board works on milivolts; the I<SUP>2</SUP>C
communication uses centivolts; the user interface uses volts; the API
uses milivolts. And all for good reasons!</P>
<P CLASS="western"><A NAME="Footnote6"></A>6. And no one complained
about the whitespace rules! Who'd have thought it?!</P>
<P CLASS="western"><A NAME="Footnote7"></A>7. In common with most
daemons, simbamon is written in shell script.</P>
<P CLASS="western"><A NAME="Footnote8"></A>8. The main archive (for
stable releases) is at
<A HREF="https://launchpad.net/~hamish-dcs/+archive/pi-gate">https://launchpad.net/~hamish-dcs/+archive/pi-gate</A>
with a development snapshot archive at
<A HREF="https://launchpad.net/~hamish-dcs/+archive/pi-gate-snapshots">https://launchpad.net/~hamish-dcs/+archive/pi-gate-snapshots</A>.
</P>
<P CLASS="western"><BR><BR>
</P>
<P CLASS="western"><BR><BR>
</P>
</BODY>
</HTML>
